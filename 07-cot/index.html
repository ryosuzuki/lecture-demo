<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CoT Prompting Demo — Normal vs Few-shot CoT vs Zero-shot “Let’s think step by step” (WebLLM)</title>
  <style>
    :root { --bg:#0b0f14; --card:#121826; --muted:#93a4b8; --text:#e8eef6; --line:#233043; --accent:#6ee7ff; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); }
    header { padding: 18px 16px; border-bottom: 1px solid var(--line); position: sticky; top:0; background: rgba(11,15,20,.92); backdrop-filter: blur(8px); z-index: 10; }
    header h1 { margin:0; font-size: 16px; }
    header p { margin: 8px 0 0; color: var(--muted); font-size: 12px; line-height: 1.4; }

    .wrap { max-width: 1250px; margin: 0 auto; padding: 16px; }
    .grid { display: grid; grid-template-columns: 420px 1fr; gap: 12px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.25); }

    .row { display:flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pill { font-size: 11px; color: var(--muted); border: 1px solid var(--line); padding: 4px 8px; border-radius: 999px; }
    .accent { color: var(--accent); }
    .tiny { font-size: 12px; color: var(--muted); line-height: 1.4; }

    label { font-size: 12px; color: var(--muted); display:block; margin: 10px 0 6px; }
    select, textarea, input, button {
      font: inherit; border-radius: 10px; border: 1px solid var(--line);
      background: #0f1623; color: var(--text); padding: 10px; outline: none;
    }
    textarea { width: 100%; min-height: 130px; resize: vertical; line-height: 1.35; }
    input[type="number"] { width: 150px; }
    button { cursor: pointer; }
    button.primary { background: linear-gradient(180deg, rgba(110,231,255,.18), rgba(110,231,255,.06)); border-color: rgba(110,231,255,.35); }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .status { padding: 10px; border-radius: 12px; border: 1px dashed var(--line); color: var(--muted); font-size: 12px; }

    .outGrid { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    pre { margin:0; white-space: pre-wrap; word-break: break-word; background:#0c1320; border:1px solid var(--line); padding: 10px; border-radius: 12px; min-height: 160px; }

    details summary { cursor:pointer; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
<header>
  <h1>CoT Prompting Demo — <span class="accent">Normal</span> vs <span class="accent">Few-shot CoT</span> vs <span class="accent">Zero-shot “Let’s think step by step”</span></h1>
  <p>
    Browser-only LLM (WebGPU) using WebLLM. Shows the prompts used (collapsible) + outputs side-by-side.
  </p>
</header>

<div class="wrap">
  <div class="grid">

    <div class="card">
      <div class="row">
        <span class="pill">browser-only</span>
        <span class="pill">10 samples</span>
        <span class="pill">3 prompting styles</span>
      </div>

      <label>Model</label>
      <select id="model">
        <option value="Qwen2.5-0.5B-Instruct-q4f16_1-MLC" selected>Qwen2.5-0.5B-Instruct (q4) — recommended</option>
        <option value="SmolLM2-360M-Instruct-q4f16_1-MLC">SmolLM2-360M-Instruct (q4) — weaker</option>
        <option value="SmolLM2-1.7B-Instruct-q4f16_1-MLC">SmolLM2-1.7B-Instruct (q4) — stronger</option>
        <option value="Qwen2.5-1.5B-Instruct-q4f16_1-MLC">Qwen2.5-1.5B-Instruct (q4) — stronger</option>
      </select>

      <label>Sample (10)</label>
      <select id="sample"></select>

      <label>Problem (editable)</label>
      <textarea id="problem" class="mono"></textarea>

      <label>Answer type (for Zero-shot-CoT stage-2 extraction)</label>
      <select id="answerType">
        <option value="number" selected>Number</option>
        <option value="yesno">Yes/No</option>
        <option value="time">Time (HH:MM AM/PM)</option>
        <option value="name">Single name</option>
        <option value="sentence">Single short sentence</option>
        <option value="translation_es">Spanish translation only</option>
        <option value="generic">Generic (final answer only)</option>
      </select>

      <label>Max output tokens</label>
      <input id="maxTok" type="number" min="32" max="512" value="160" />

      <label>Sampling</label>
      <div class="row">
        <div>
          <div class="tiny">Temperature</div>
          <input id="temp" type="number" min="0" max="2" step="0.1" value="0.2" />
        </div>
        <div>
          <div class="tiny">Top-p</div>
          <input id="topp" type="number" min="0" max="1" step="0.05" value="0.9" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnInit" class="primary">Init / Load model</button>
        <button id="btnRun" class="primary" disabled>Run (Normal / Few-shot CoT / Zero-shot-CoT)</button>
        <button id="btnReset">Reset sample</button>
      </div>

      <div id="status" class="status" style="margin-top:12px;">Status: not initialized</div>

      <details style="margin-top:12px;">
        <summary>What’s implemented (paper-faithful templates)</summary>
        <div class="tiny" style="margin-top:8px;">
          <ul>
            <li><b>Normal</b>: <span class="mono">Q: ... A:</span> (answer directly)</li>
            <li><b>Few-shot CoT (Wei-style)</b>: multiple <span class="mono">Q/A</span> exemplars with short rationales + <span class="mono">The answer is ...</span>, then the test <span class="mono">Q/A</span>.</li>
            <li><b>Zero-shot-CoT (Kojima-style)</b>: Stage 1 prompt ends with <span class="mono">A: Let’s think step by step.</span>, then Stage 2 extracts the answer using a task-specific trigger.</li>
          </ul>
        </div>
      </details>
    </div>

    <div class="card">
      <div class="tiny">Outputs</div>

      <div class="outGrid">
        <div>
          <div class="tiny">Normal output</div>
          <pre id="outN" class="mono"></pre>
        </div>
        <div>
          <div class="tiny">Few-shot CoT output</div>
          <pre id="outF" class="mono"></pre>
        </div>
        <div>
          <div class="tiny">Zero-shot “Let’s think step by step” output (final)</div>
          <pre id="outZ" class="mono"></pre>
        </div>
      </div>

      <div style="margin-top:12px;">
        <details>
          <summary>Show prompts used (Normal / Few-shot CoT / Zero-shot-CoT Stage 1 & Stage 2)</summary>
          <div class="outGrid" style="margin-top:10px;">
            <div>
              <div class="tiny">Normal prompt</div>
              <pre id="pN" class="mono" style="min-height:140px;"></pre>
            </div>
            <div>
              <div class="tiny">Few-shot CoT prompt</div>
              <pre id="pF" class="mono" style="min-height:140px;"></pre>
            </div>
            <div>
              <div class="tiny">Zero-shot-CoT prompts</div>
              <div class="tiny" style="margin:6px 0;">Stage 1 (reasoning extraction)</div>
              <pre id="pZ1" class="mono" style="min-height:120px;"></pre>
              <div class="tiny" style="margin:10px 0 6px;">Stage 2 (answer extraction)</div>
              <pre id="pZ2" class="mono" style="min-height:120px;"></pre>
            </div>
          </div>
        </details>
      </div>

      <div style="margin-top:12px;">
        <details>
          <summary>Show Zero-shot-CoT Stage 1 reasoning text (model output)</summary>
          <pre id="zRationale" class="mono" style="min-height:140px;"></pre>
        </details>
      </div>

      <div style="margin-top:12px;">
        <details open>
          <summary>Prompt preview (Few-shot CoT)</summary>
          <pre id="preview" class="mono"></pre>
        </details>
      </div>

    </div>

  </div>
</div>

<script type="module">
  import * as webllm from "https://esm.run/@mlc-ai/web-llm";

  const $ = (id) => document.getElementById(id);

  const modelSel = $("model");
  const sampleSel = $("sample");
  const problemEl = $("problem");
  const answerTypeSel = $("answerType");

  const maxTokEl = $("maxTok");
  const tempEl = $("temp");
  const toppEl = $("topp");

  const btnInit = $("btnInit");
  const btnRun = $("btnRun");
  const btnReset = $("btnReset");
  const statusEl = $("status");

  const outN = $("outN");
  const outF = $("outF");
  const outZ = $("outZ");

  const pN = $("pN");
  const pF = $("pF");
  const pZ1 = $("pZ1");
  const pZ2 = $("pZ2");

  const zRationale = $("zRationale");
  const preview = $("preview");

  let engine = null;

  // Few-shot CoT exemplars (Wei-style Q/A with short rationale + "The answer is ...")
  const COT_EXEMPLARS = `Q: There are 15 trees in the grove. Grove workers will plant trees in the grove today. After they are done, there will be 21 trees. How many trees did the grove workers plant today?
A: There are 21 trees now and 15 trees in the beginning, so the workers plant 21 - 15 = 6 trees. The answer is 6.

Q: If there are 3 cars in the parking lot and 2 more cars arrive, how many cars are in the parking lot?
A: There are originally 3 cars and 2 more arrive, so 3 + 2 = 5. The answer is 5.`;

  const SAMPLES = [
    { title: "1) Arithmetic (multi-step)", type: "number",
      problem: "A book costs $12. You buy 3 books and pay with a $50 bill. How much change do you get? Answer with a number." },
    { title: "2) Unit conversion", type: "number",
      problem: "Convert 3.5 kilometers to meters. Answer with a number." },
    { title: "3) Logic (constraint)", type: "yesno",
      problem: "If all zorps are flargs, and no flargs are blins, can a zorp be a blin? Answer Yes or No." },
    { title: "4) Probability", type: "generic",
      problem: "A fair coin is flipped 3 times. What is the probability of getting exactly 2 heads? Give a simplified fraction." },
    { title: "5) Time arithmetic", type: "time",
      problem: "A meeting starts at 9:20 AM and lasts 1 hour 35 minutes. What time does it end? Answer in HH:MM AM/PM." },
    { title: "6) Tiny table reasoning", type: "name",
      problem:
`You have this table:
- Alice: 2 apples
- Bob: 5 apples
- Cara: 3 apples
Who has the most apples? Answer with one name.` },
    { title: "7) Common-sense physics", type: "sentence",
      problem: "You put an ice cube in a warm room. After some time, what happens to it? Answer in one short sentence." },
    { title: "8) Definition (short)", type: "sentence",
      problem: "What is 'in-context learning' in language models? Answer in one short sentence." },
    { title: "9) Pattern completion", type: "number",
      problem: "Complete the pattern: 2, 4, 8, 16, __. Answer with a number." },
    { title: "10) Translation (EN → ES)", type: "translation_es",
      problem: "Translate to Spanish: 'Please submit the PDF by Wednesday morning.' Return ONLY the Spanish translation." },
  ];

  function setStatus(s) { statusEl.textContent = "Status: " + s; }
  function clearOut() {
    outN.textContent = "";
    outF.textContent = "";
    outZ.textContent = "";
    zRationale.textContent = "";
  }

  function answerTriggerFor(type) {
    if (type === "number") return "Therefore, the answer (Arabic numerals) is";
    if (type === "yesno") return "Therefore, the answer (Yes or No) is";
    if (type === "time") return "Therefore, the answer (time) is";
    if (type === "name") return "Therefore, the answer (name) is";
    if (type === "sentence") return "Therefore, the final answer (one short sentence) is";
    if (type === "translation_es") return "Therefore, the Spanish translation is";
    return "Therefore, the final answer is";
  }

  function buildPrompts(problem, answerType) {
    const normal =
`Q: ${problem}
A:`;

    const fewShotCoT =
`${COT_EXEMPLARS}

Q: ${problem}
A:`;

    const zeroShotCoT_stage1 =
`Q: ${problem}
A: Let's think step by step.`;

    const trigger = answerTriggerFor(answerType);

    return { normal, fewShotCoT, zeroShotCoT_stage1, trigger };
  }

  function refreshPromptViews() {
    const problem = problemEl.value.trim();
    const answerType = answerTypeSel.value;
    const { normal, fewShotCoT, zeroShotCoT_stage1, trigger } = buildPrompts(problem, answerType);

    pN.textContent = normal;
    pF.textContent = fewShotCoT;
    pZ1.textContent = zeroShotCoT_stage1;

    preview.textContent = fewShotCoT;

    // Stage 2 is constructed after stage 1 rationale is generated (see runZeroShotCoT).
    pZ2.textContent = `(Stage 2 prompt will appear after running Zero-shot-CoT)\nTrigger: ${trigger}`;

    return { normal, fewShotCoT, zeroShotCoT_stage1, trigger };
  }

  async function init() {
    btnInit.disabled = true;
    btnRun.disabled = true;
    clearOut();
    setStatus("Initializing engine…");

    try {
      const modelId = modelSel.value;
      engine = new webllm.MLCEngine();
      await engine.reload(modelId, {
        initProgressCallback: (report) => {
          const pct = report.progress != null ? Math.round(report.progress * 100) : null;
          setStatus(report.text + (pct != null ? ` (${pct}%)` : ""));
        },
      });
      setStatus("Ready ✅");
      btnRun.disabled = false;
    } catch (e) {
      console.error(e);
      setStatus("Init failed: " + (e?.message || e));
      engine = null;
    } finally {
      btnInit.disabled = false;
    }
  }

  async function complete(prompt) {
    const max_tokens = Math.max(32, Math.min(512, Number(maxTokEl.value || 160)));
    const temperature = Number(tempEl.value || 0.2);
    const top_p = Number(toppEl.value || 0.9);

    const res = await engine.chat.completions.create({
      messages: [{ role: "user", content: prompt }],
      max_tokens,
      temperature,
      top_p,
    });

    return res.choices?.[0]?.message?.content?.trim?.() ?? "";
  }

  async function runZeroShotCoT(problem, answerType) {
    const { zeroShotCoT_stage1, trigger } = buildPrompts(problem, answerType);

    // Stage 1: reasoning extraction
    const rationale = await complete(zeroShotCoT_stage1);

    // Stage 2: answer extraction
    const stage2 =
`${zeroShotCoT_stage1}
${rationale}

${trigger}`;

    const final = await complete(stage2);

    return { rationale, stage2, final };
  }

  async function runAll() {
    if (!engine) return;

    btnRun.disabled = true;
    btnInit.disabled = true;
    clearOut();

    const problem = problemEl.value.trim();
    const answerType = answerTypeSel.value;

    const { normal, fewShotCoT } = refreshPromptViews();

    try {
      setStatus("Running Normal…");
      outN.textContent = await complete(normal);

      setStatus("Running Few-shot CoT…");
      outF.textContent = await complete(fewShotCoT);

      setStatus("Running Zero-shot-CoT (2-stage)…");
      const z = await runZeroShotCoT(problem, answerType);

      zRationale.textContent = z.rationale;
      pZ2.textContent = z.stage2;
      outZ.textContent = z.final;

      setStatus("Done ✅");
    } catch (e) {
      console.error(e);
      setStatus("Run failed: " + (e?.message || e));
    } finally {
      btnRun.disabled = !engine;
      btnInit.disabled = false;
    }
  }

  function setupSamples() {
    sampleSel.innerHTML = "";
    SAMPLES.forEach((s, i) => {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = s.title;
      sampleSel.appendChild(opt);
    });
    sampleSel.value = "0";
    loadSample(0);
  }

  function loadSample(i) {
    const s = SAMPLES[i];
    problemEl.value = s.problem;
    answerTypeSel.value = s.type || "generic";
    refreshPromptViews();
    clearOut();
    setStatus(engine ? "Ready ✅" : "Not initialized");
  }

  btnInit.addEventListener("click", init);
  btnRun.addEventListener("click", runAll);
  btnReset.addEventListener("click", () => loadSample(Number(sampleSel.value)));

  modelSel.addEventListener("change", () => {
    engine = null;
    btnRun.disabled = true;
    setStatus("Model changed (click Init / Load model)");
  });

  sampleSel.addEventListener("change", () => loadSample(Number(sampleSel.value)));
  ["input", "change"].forEach(evt => {
    problemEl.addEventListener(evt, refreshPromptViews);
    answerTypeSel.addEventListener(evt, refreshPromptViews);
  });

  setupSamples();
</script>
</body>
</html>
